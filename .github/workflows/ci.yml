name: CI

on:
  pull_request:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  test-count-floor:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x

      - name: Restore
        run: dotnet restore

      - name: Verify discovered test count floor
        run: ./scripts/ci/verify_test_count_floor.sh --mode verify --baseline docs/ci/test_count_baseline.json

  update-test-count-baseline:
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x

      - name: Restore
        run: dotnet restore

      - name: Print discovered test counts for baseline update
        run: ./scripts/ci/verify_test_count_floor.sh --mode report --baseline docs/ci/test_count_baseline.json

  canary:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x

      - name: Test Category Hygiene Guard
        if: github.event_name == 'pull_request'
        run: |
          set -euo pipefail
          BASE_SHA="${{ github.event.pull_request.base.sha }}"
          echo "Running category hygiene diff against base SHA: ${BASE_SHA}"

          changed_files="$(git diff --name-only "${BASE_SHA}"...HEAD -- ':(glob)tests/**/*.cs')"
          if [ -z "${changed_files}" ]; then
            echo "No changed test files detected in PR."
            exit 0
          fi

          python - <<'PY'
          import re
          import subprocess
          import sys

          base_sha = "${{ github.event.pull_request.base.sha }}"

          changed = subprocess.check_output(
              ["git", "diff", "--name-only", f"{base_sha}...HEAD", "--", ":(glob)tests/**/*.cs"],
              text=True,
          )
          files = [line.strip() for line in changed.splitlines() if line.strip()]

          test_attr_re = re.compile(r"^\s*\[(Fact|Theory)\b", re.IGNORECASE)
          method_sig_re = re.compile(
              r"^\s*(public|internal|private|protected)\s+(?:async\s+)?(?:[\w<>,\[\]\.?]+\s+)+\w+\s*\(",
              re.IGNORECASE,
          )
          category_trait_re = re.compile(
              r'\[\s*Trait\s*\(\s*"Category"\s*,\s*"([^"]+)"\s*\)\s*\]',
              re.IGNORECASE,
          )
          pr_category_re = re.compile(r"^PR\d+$", re.IGNORECASE)

          violations = []

          for path in files:
              diff_text = subprocess.check_output(
                  ["git", "diff", "-U200", f"{base_sha}...HEAD", "--", path],
                  text=True,
              )

              added_lines = []
              for line in diff_text.splitlines():
                  if line.startswith("+++"):
                      continue
                  if line.startswith("+"):
                      added_lines.append(line[1:])

              collecting = False
              attrs = []

              for line in added_lines:
                  if test_attr_re.search(line):
                      collecting = True
                      attrs = [line]
                      continue

                  if not collecting:
                      continue

                  stripped = line.strip()
                  if stripped.startswith("["):
                      attrs.append(line)
                      continue

                  if method_sig_re.search(line):
                      categories = []
                      for attr_line in attrs:
                          categories.extend(category_trait_re.findall(attr_line))

                      if not categories:
                          violations.append(
                              f"{path}: new test method '{line.strip()}' is missing [Trait(\"Category\", \"...\")]."
                          )
                      else:
                          category_set = {c.strip() for c in categories}
                          has_pr = any(pr_category_re.match(c) for c in category_set)
                          has_canary = "Canary" in category_set
                          has_exception = bool({"Soak", "Perf"} & category_set)
                          if has_pr and not has_canary and not has_exception:
                              violations.append(
                                  f"{path}: new test method '{line.strip()}' uses PRxx category {sorted(category_set)} "
                                  "but is missing Category=Canary (unless Soak/Perf is set)."
                              )

                      collecting = False
                      attrs = []
                  elif stripped and not stripped.startswith("//"):
                      collecting = False
                      attrs = []

          if violations:
              print("Category hygiene violations detected:")
              for v in violations:
                  print(f" - {v}")
              sys.exit(1)

          print("Category hygiene guard passed.")
          PY

      - name: Restore
        run: dotnet restore

      - name: Verify integration test file integrity (pre-build)
        run: |
          echo "HEAD=$(git rev-parse HEAD)"
          python - <<'PY'
          from pathlib import Path

          path = Path("tests/Game.Server.Tests/ServerHostIntegrationTests.cs")
          text = path.read_text(encoding="utf-8")

          required_tokens = [
              "const int inputCount = 30;",
              "client.SendInput(previousTick + 1, moveX, moveY);",
              "AppendSnapshot(checksum, currentSnapshot with { Tick = i + 1 });",
              "Assert.True(moved);",
          ]

          missing = [token for token in required_tokens if token not in text]
          if missing:
              print(f"{path} appears corrupted/truncated. Missing tokens:")
              for token in missing:
                  print(f" - {token}")
              print("\nSuggested fix:")
              print(" - Restore tests/Game.Server.Tests/ServerHostIntegrationTests.cs from a known-good commit and push again.")
              print(" - Example: git checkout <good_sha> -- tests/Game.Server.Tests/ServerHostIntegrationTests.cs")
              raise SystemExit(1)

          print(f"Verified {path} integrity checks ({len(required_tokens)} tokens).")
          PY

      - name: Build
        run: dotnet build -c Release --no-restore

      - name: Canary test lane
        run: dotnet test -c Release --no-build --filter "Category=Canary" --logger "console;verbosity=detailed"

  full:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x

      - name: Restore
        run: dotnet restore

      - name: Build
        run: dotnet build -c Release --no-restore

      - name: Full deterministic suite (excluding soak)
        run: dotnet test -c Release --no-build --filter "Category!=Soak" --logger "console;verbosity=detailed" --blame --blame-hang-timeout 2m

      - name: MVP7 verification gate
        run: ./scripts/verify_mvp7.sh

      - name: Persistence consistency gate
        run: dotnet test -c Release --no-build --filter "Category=Persistence" --logger "console;verbosity=normal"

      - name: MVP1 verify gate (headless)
        run: dotnet run -c Release --project src/Game.App.Headless -- --verify-mvp1

  dod-gate:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x

      - name: Restore
        run: dotnet restore

      - name: Build
        run: dotnet build -c Release --no-restore

      - name: DoD drift gate
        run: dotnet test -c Release --no-build --filter "Category=DoD" --logger "console;verbosity=detailed"

      - name: Replay verify golden drift gate
        run: dotnet test -c Release --no-build --filter "Category=ReplayVerify" --logger "console;verbosity=normal"

  full-audit:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x

      - name: Restore
        run: dotnet restore

      - name: Build
        run: dotnet build -c Release --no-restore

      - name: Full test audit (no category filter)
        run: dotnet test -c Release --no-build --logger "console;verbosity=detailed"
